# 页面级分析配置使用指南

## 概述

本项目支持页面级别的 Google Analytics (GA) 和转化跟踪配置。每个单页可以配置自己的 GA 转化 ID 和转化标签，实现独立的分析和转化跟踪。

## 架构说明

### 核心组件

1. **`usePageAnalytics` composable** - 页面级分析配置
2. **`useContactForm` composable** - 支持页面级转化跟踪的表单
3. **Cookie 同意插件** - 通过事件机制通知页面加载 GA

### 工作流程

1. Cookie 同意插件检测用户同意状态
2. 如果用户同意分析 Cookie，触发 `analytics-consent-given` 事件
3. 页面中的 `usePageAnalytics` 监听事件并加载对应的 GA
4. 表单提交成功后，调用页面配置的转化跟踪函数

## 使用方法

### 1. 在页面中配置 GA

在页面文件（如 `app/pages/diesel/index.vue`）中：

```vue
<script setup lang="ts">
// 配置页面级别的 Google Analytics 和转化跟踪
const { reportConversion } = usePageAnalytics({
  conversionId: 'AW-10801798623',        // 你的 Google Ads 转化 ID
  conversionLabel: 'mSIWCPH6iIMYEN-72Z4o', // 你的转化标签 ID
  autoLoad: true                           // 自动加载（默认: true）
})

// 将转化跟踪函数暴露给组件使用
provide('pageConversionTrack', reportConversion)
</script>
```

### 2. 在组件中使用配置了转化跟踪的表单

在组件文件（如 `app/components/diesel/MainPage.vue`）中：

```vue
<script setup lang="ts">
// 获取页面级别的转化跟踪函数
const pageConversionTrack = inject<(() => void) | undefined>('pageConversionTrack')

// 使用联系表单组合函数，传入页面级别的转化跟踪函数
const {
  contactForm,
  handleFormSubmit,
  isSubmitting,
} = useContactForm({
  onConversionTrack: pageConversionTrack  // 传入页面级别的转化跟踪函数
})
</script>
```

### 3. 完整示例

#### 页面文件 (`app/pages/diesel/index.vue`)

```vue
<template>
  <div class="index-page">
    <DieselMainPage />
  </div>
</template>

<script setup lang="ts">
// 配置页面级别的 Google Analytics 和转化跟踪
const { reportConversion } = usePageAnalytics({
  conversionId: 'AW-10801798623',
  conversionLabel: 'mSIWCPH6iIMYEN-72Z4o',
  autoLoad: true
})

// 将转化跟踪函数暴露给组件使用
provide('pageConversionTrack', reportConversion)
</script>
```

#### 组件文件 (`app/components/diesel/MainPage.vue`)

```vue
<template>
  <div class="main-page">
    <!-- 表单部分 -->
    <UForm :state="contactForm" @submit="handleFormSubmit">
      <!-- 表单字段 -->
    </UForm>
  </div>
</template>

<script setup lang="ts">
// 获取页面级别的转化跟踪函数
const pageConversionTrack = inject<(() => void) | undefined>('pageConversionTrack')

// 使用联系表单组合函数
const {
  contactForm,
  handleFormSubmit,
  isSubmitting,
} = useContactForm({
  onConversionTrack: pageConversionTrack
})
</script>
```

## 配置选项

### `usePageAnalytics` 配置

```typescript
interface GoogleAnalyticsConfig {
  /** Google Ads 转化 ID (例如: AW-10801798623) */
  conversionId: string
  /** 转化标签 ID (例如: mSIWCPH6iIMYEN-72Z4o) */
  conversionLabel: string
  /** 是否自动加载 GA (默认: true) */
  autoLoad?: boolean
}
```

### `useContactForm` 配置

```typescript
interface UseContactFormOptions {
  extraData?: ExtraDataType[]
  customFields?: Record<string, any>
  /** 页面级别的转化跟踪函数（可选） */
  onConversionTrack?: () => void
}
```

## 返回值

### `usePageAnalytics` 返回值

```typescript
{
  loadGoogleAnalytics: () => void        // 手动加载 GA
  reportConversion: (url?: string) => void  // 触发转化跟踪
  hasAnalyticsConsent: () => boolean     // 检查是否同意分析 Cookie
  initPageAnalytics: () => void          // 初始化页面分析
}
```

## 工作原理

### Cookie 同意流程

1. 用户首次访问页面，Cookie 同意弹窗出现
2. 用户同意分析 Cookie
3. Cookie 同意插件触发 `analytics-consent-given` 事件
4. `usePageAnalytics` 监听事件并加载对应的 GA 脚本

### 转化跟踪流程

1. 用户填写表单并提交
2. 表单提交成功后，`useContactForm` 调用 `onConversionTrack` 函数
3. `onConversionTrack` 调用页面配置的 `reportConversion` 函数
4. `reportConversion` 触发 Google Ads 转化跟踪

## 注意事项

1. **每个页面独立配置**：每个单页需要单独配置自己的 `conversionId` 和 `conversionLabel`
2. **Cookie 同意是前提**：只有在用户同意分析 Cookie 后，GA 才会加载
3. **转化跟踪函数**：必须通过 `provide/inject` 将转化跟踪函数传递给组件
4. **自动加载**：默认 `autoLoad: true`，会在页面加载时自动初始化

## 迁移指南

### 从全局 GA 迁移到页面级 GA

**之前（全局配置）：**
- GA 配置在 `cookieconsent.client.ts` 中硬编码
- 所有页面共享同一个 GA 配置

**现在（页面级配置）：**
1. 在页面文件中使用 `usePageAnalytics` 配置自己的 GA
2. 在组件中通过 `inject` 获取转化跟踪函数
3. 将转化跟踪函数传递给 `useContactForm`

## 示例：添加新页面

假设要添加一个新的单页 `/chiller`：

1. **创建页面文件** (`app/pages/chiller/index.vue`)：

```vue
<template>
  <div class="index-page">
    <ChillerMainPage />
  </div>
</template>

<script setup lang="ts">
// 配置这个页面的 GA（使用不同的转化 ID）
const { reportConversion } = usePageAnalytics({
  conversionId: 'AW-ANOTHER-ID',        // 这个页面的转化 ID
  conversionLabel: 'ANOTHER-LABEL',     // 这个页面的转化标签
  autoLoad: true
})

provide('pageConversionTrack', reportConversion)
</script>
```

2. **在组件中使用** (`app/components/chiller/MainPage.vue`)：

```vue
<script setup lang="ts">
const pageConversionTrack = inject<(() => void) | undefined>('pageConversionTrack')

const {
  contactForm,
  handleFormSubmit,
  isSubmitting,
} = useContactForm({
  onConversionTrack: pageConversionTrack
})
</script>
```

## 故障排查

### GA 未加载

1. 检查用户是否同意了分析 Cookie
2. 检查 `conversionId` 和 `conversionLabel` 是否正确
3. 检查浏览器控制台是否有错误信息

### 转化跟踪未触发

1. 检查是否通过 `provide/inject` 正确传递了转化跟踪函数
2. 检查表单提交是否成功
3. 检查 GA 是否已加载（`typeof window.gtag !== 'undefined'`）

### Cookie 同意事件未触发

1. 检查 Cookie 同意插件是否正确加载
2. 检查用户是否已经同意过 Cookie（可能不会再次触发事件）
3. 检查浏览器控制台是否有错误信息

