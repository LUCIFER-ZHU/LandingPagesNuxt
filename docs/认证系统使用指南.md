# è®¤è¯ç³»ç»Ÿä½¿ç”¨æŒ‡å—

æœ¬é¡¹ç›®å·²å®ç°å®Œæ•´çš„ç”¨æˆ·è®¤è¯ç³»ç»Ÿï¼ŒåŒ…æ‹¬æ³¨å†Œã€ç™»å½•å’Œé‡ç½®å¯†ç åŠŸèƒ½ã€‚

## ğŸš€ åŠŸèƒ½æ¦‚è§ˆ

### 1. æ³¨å†Œé¡µé¢ (`/account/register`)

**åŠŸèƒ½ç‰¹æ€§ï¼š**
- é‚®ç®±æ³¨å†Œ
- éªŒè¯ç éªŒè¯ï¼ˆ90ç§’å€’è®¡æ—¶ï¼‰
- å¯†ç è®¾ç½®
- å¯é€‰ç”¨æˆ·å

**ä½¿ç”¨æµç¨‹ï¼š**
1. è¾“å…¥é‚®ç®±åœ°å€
2. ç‚¹å‡»"Send Code"æŒ‰é’®è·å–éªŒè¯ç 
3. è¾“å…¥æ”¶åˆ°çš„éªŒè¯ç 
4. è®¾ç½®å¯†ç 
5. ï¼ˆå¯é€‰ï¼‰è¾“å…¥ç”¨æˆ·å
6. ç‚¹å‡»"Register"å®Œæˆæ³¨å†Œ
7. æ³¨å†ŒæˆåŠŸåè‡ªåŠ¨è·³è½¬åˆ°ç™»å½•é¡µ

**API æ¥å£ï¼š**
- å‘é€éªŒè¯ç ï¼š`sendRegisterCode(email)` â†’ `POST /business/customer/sendCode`
- æ³¨å†Œï¼š`register(data)` â†’ `POST /business/customer/register`

### 2. ç™»å½•é¡µé¢ (`/account/login`)

**åŠŸèƒ½ç‰¹æ€§ï¼š**
- é‚®ç®±ç™»å½•
- å¯†ç éªŒè¯
- ç™»å½•çŠ¶æ€æŒä¹…åŒ–ï¼ˆlocalStorageï¼‰
- å¿˜è®°å¯†ç é“¾æ¥

**ä½¿ç”¨æµç¨‹ï¼š**
1. è¾“å…¥é‚®ç®±åœ°å€
2. è¾“å…¥å¯†ç 
3. ç‚¹å‡»"Sign in"ç™»å½•
4. ç™»å½•æˆåŠŸåè·³è½¬åˆ°é¦–é¡µ

**API æ¥å£ï¼š**
- ç™»å½•ï¼š`login(data)` â†’ `POST /business/customer/login`

### 3. é‡ç½®å¯†ç é¡µé¢ (`/account/reset`)

**åŠŸèƒ½ç‰¹æ€§ï¼š**
- é€šè¿‡é‚®ç®±é‡ç½®å¯†ç 
- éªŒè¯ç éªŒè¯ï¼ˆ90ç§’å€’è®¡æ—¶ï¼‰
- è®¾ç½®æ–°å¯†ç 

**ä½¿ç”¨æµç¨‹ï¼š**
1. è¾“å…¥é‚®ç®±åœ°å€
2. ç‚¹å‡»"Send Code"æŒ‰é’®è·å–é‡ç½®éªŒè¯ç 
3. è¾“å…¥æ”¶åˆ°çš„éªŒè¯ç 
4. è®¾ç½®æ–°å¯†ç 
5. ç‚¹å‡»"Reset Password"å®Œæˆé‡ç½®
6. é‡ç½®æˆåŠŸåè·³è½¬åˆ°ç™»å½•é¡µ

**API æ¥å£ï¼š**
- å‘é€é‡ç½®éªŒè¯ç ï¼š`sendResetCode(email)` â†’ `POST /business/customer/sendResetCode`
- é‡ç½®å¯†ç ï¼š`resetPassword(data)` â†’ `POST /business/customer/resetPassword`

## ğŸ“¦ Auth Store

é¡¹ç›®ä½¿ç”¨ Pinia ç®¡ç†ç”¨æˆ·è®¤è¯çŠ¶æ€ï¼Œä½äº `app/stores/auth.ts`ã€‚

### State ç»“æ„

```typescript
interface AuthState {
  user: User | null           // ç”¨æˆ·ä¿¡æ¯
  token: string | null        // è®¤è¯ä»¤ç‰Œ
  isAuthenticated: boolean    // æ˜¯å¦å·²è®¤è¯
}

interface User {
  id?: string | number
  email?: string
  customerName?: string
  [key: string]: any
}
```

### å¯ç”¨æ–¹æ³•

```typescript
// è®¾ç½®ç”¨æˆ·ä¿¡æ¯å’Œ token
authStore.setAuth(user, token)

// æ›´æ–°ç”¨æˆ·ä¿¡æ¯
authStore.setUser(user)

// è®¾ç½® token
authStore.setToken(token)

// æ¸…é™¤è®¤è¯ä¿¡æ¯
authStore.clearAuth()

// ç™»å‡ºï¼ˆæ¸…é™¤ä¿¡æ¯å¹¶è·³è½¬åˆ°ç™»å½•é¡µï¼‰
await authStore.logout()
```

### Getters

```typescript
authStore.getUser         // è·å–ç”¨æˆ·ä¿¡æ¯
authStore.getToken        // è·å– token
authStore.isLoggedIn      // æ˜¯å¦å·²ç™»å½•
```

### åœ¨ç»„ä»¶ä¸­ä½¿ç”¨

```vue
<script setup lang="ts">
import { useAuthStore } from '~/stores/auth'

const authStore = useAuthStore()

// æ£€æŸ¥æ˜¯å¦ç™»å½•
if (authStore.isLoggedIn) {
  console.log('User:', authStore.getUser)
}

// ç™»å‡º
const handleLogout = async () => {
  await authStore.logout()
}
</script>
```

## ğŸ“ API ç®¡ç†

æ‰€æœ‰è®¤è¯ç›¸å…³çš„ API æ¥å£ç»Ÿä¸€ç®¡ç†åœ¨ `app/api/auth.ts` æ–‡ä»¶ä¸­ï¼Œæä¾›ç±»å‹å®‰å…¨çš„æ¥å£è°ƒç”¨ã€‚

### å¯ç”¨ API å‡½æ•°

```typescript
// å‘é€æ³¨å†ŒéªŒè¯ç 
import { sendRegisterCode } from '~/api/auth'
await sendRegisterCode('user@example.com')

// ç”¨æˆ·æ³¨å†Œ
import { register, type RegisterRequest } from '~/api/auth'
const data: RegisterRequest = {
  email: 'user@example.com',
  code: '123456',
  password: 'password123',
  customerName: 'John Doe' // å¯é€‰
}
await register(data)

// ç”¨æˆ·ç™»å½•
import { login, type LoginRequest } from '~/api/auth'
const data: LoginRequest = {
  email: 'user@example.com',
  password: 'password123'
}
await login(data)

// å‘é€é‡ç½®å¯†ç éªŒè¯ç 
import { sendResetCode } from '~/api/auth'
await sendResetCode('user@example.com')

// é‡ç½®å¯†ç 
import { resetPassword, type ResetPasswordRequest } from '~/api/auth'
const data: ResetPasswordRequest = {
  email: 'user@example.com',
  code: '123456',
  newPassword: 'newPassword123'
}
await resetPassword(data)
```

### åœ¨ç»„ä»¶ä¸­ä½¿ç”¨

```vue
<script setup lang="ts">
import { login, type LoginRequest } from '~/api/auth'

const handleLogin = async () => {
  try {
    const data: LoginRequest = {
      email: 'user@example.com',
      password: 'password123'
    }
    const response = await login(data)
    console.log('ç™»å½•æˆåŠŸ', response)
  } catch (error) {
    console.error('ç™»å½•å¤±è´¥', error)
  }
}
</script>
```

## ğŸ”§ æŠ€æœ¯æ ˆ

- **UI ç»„ä»¶åº“**: Nuxt UI (v4.0.1) - UCard, UInput, UButton ç­‰
- **çŠ¶æ€ç®¡ç†**: Pinia (v3.0.3) + pinia-plugin-persistedstate
- **HTTP è¯·æ±‚**: è‡ªå®šä¹‰å°è£…çš„ `$customFetch` (åœ¨ API å±‚ç»Ÿä¸€è°ƒç”¨)
- **é€šçŸ¥æç¤º**: useToast (æ¥è‡ª Nuxt UI)
- **è·¯ç”±**: Nuxt 3 å†…ç½®è·¯ç”± (`navigateTo`)
- **è¡¨å•**: åŸç”Ÿ HTML label + Nuxt UI Input ç»„ä»¶

## ğŸ¨ UI ç‰¹æ€§

- å“åº”å¼è®¾è®¡ï¼Œé€‚é…ç§»åŠ¨ç«¯å’Œæ¡Œé¢ç«¯
- æ·±è‰²æ¨¡å¼æ”¯æŒ
- è¡¨å•éªŒè¯å’Œé”™è¯¯æç¤º
- åŠ è½½çŠ¶æ€æŒ‡ç¤º
- å€’è®¡æ—¶åŠŸèƒ½ï¼ˆéªŒè¯ç å‘é€ï¼‰
- ä¼˜é›…çš„é¡µé¢è·³è½¬

## ğŸ” å®‰å…¨ç‰¹æ€§

- é‚®ç®±æ ¼å¼éªŒè¯
- å¿…å¡«å­—æ®µéªŒè¯
- éªŒè¯ç è¿‡æœŸæ§åˆ¶ï¼ˆ90ç§’ï¼‰
- å¯†ç ä¸å¯è§è¾“å…¥
- Token æŒä¹…åŒ–å­˜å‚¨
- é”™è¯¯ä¿¡æ¯è„±æ•å¤„ç†

## ğŸ“ æ³¨æ„äº‹é¡¹

1. **éªŒè¯ç æœ‰æ•ˆæœŸ**ï¼šéªŒè¯ç å‘é€åéœ€åœ¨ 90 ç§’å†…ä½¿ç”¨
2. **Token ç®¡ç†**ï¼šToken å­˜å‚¨åœ¨ localStorage ä¸­ï¼Œåˆ·æ–°é¡µé¢ä¸ä¼šä¸¢å¤±
3. **API åŸºåœ°å€**ï¼šæ‰€æœ‰è¯·æ±‚è‡ªåŠ¨ä½¿ç”¨ç¯å¢ƒå˜é‡ä¸­é…ç½®çš„ `apiBase`
4. **é”™è¯¯å¤„ç†**ï¼šæ‰€æœ‰ API é”™è¯¯éƒ½ä¼šé€šè¿‡ toast æç¤ºç»™ç”¨æˆ·
5. **ç™»å½•è·³è½¬**ï¼šç™»å½•æˆåŠŸåé»˜è®¤è·³è½¬åˆ°é¦–é¡µ (`/`)ï¼Œå¯æ ¹æ®éœ€è¦ä¿®æ”¹

## ğŸš¦ é¡µé¢è·¯ç”±

- æ³¨å†Œé¡µï¼š`/account/register`
- ç™»å½•é¡µï¼š`/account/login`
- é‡ç½®å¯†ç ï¼š`/account/reset`

## ğŸ—ï¸ æ¶æ„è®¾è®¡

### API å±‚ï¼ˆapp/api/ï¼‰

æ‰€æœ‰åç«¯æ¥å£è°ƒç”¨éƒ½å°è£…åœ¨ `app/api/` ç›®å½•ä¸‹ï¼ŒæŒ‰åŠŸèƒ½æ¨¡å—åˆ’åˆ†ï¼š

- `auth.ts` - è®¤è¯ç›¸å…³æ¥å£ï¼ˆæ³¨å†Œã€ç™»å½•ã€é‡ç½®å¯†ç ç­‰ï¼‰
- å…¶ä»–æ¨¡å—å¯ä»¥åœ¨æ­¤ç›®å½•ä¸‹æ‰©å±•

**ä¼˜åŠ¿ï¼š**
- ç»Ÿä¸€ç®¡ç† API æ¥å£
- TypeScript ç±»å‹å®‰å…¨
- æ˜“äºç»´æŠ¤å’Œæµ‹è¯•
- å¤ç”¨æ€§å¼º

### è·¯ç”±ç®¡ç†

é¡¹ç›®ä½¿ç”¨ Nuxt 3 çš„å†…ç½®è·¯ç”±ç³»ç»Ÿï¼Œæ‰€æœ‰é¡µé¢è·³è½¬ä½¿ç”¨ `navigateTo` è€Œé `vue-router`ï¼š

```typescript
// âœ… æ­£ç¡®ï¼šä½¿ç”¨ navigateTo
await navigateTo('/account/login')

// âŒ é”™è¯¯ï¼šä¸ä½¿ç”¨ router.push
// router.push('/account/login')
```

**navigateTo ä¼˜åŠ¿ï¼š**
- SSR å‹å¥½
- æ”¯æŒæœåŠ¡ç«¯å’Œå®¢æˆ·ç«¯
- è‡ªåŠ¨å¤„ç†è·¯ç”±é¢„åŠ è½½
- æ›´å¥½çš„æ€§èƒ½

## ğŸ’¡ å¼€å‘å»ºè®®

### æ·»åŠ è·¯ç”±å®ˆå«

å¯ä»¥åœ¨ `app/middleware/auth.ts` ä¸­æ·»åŠ è·¯ç”±å®ˆå«ï¼Œä¿æŠ¤éœ€è¦ç™»å½•çš„é¡µé¢ï¼š

```typescript
export default defineNuxtRouteMiddleware((to, from) => {
  const authStore = useAuthStore()
  
  // éœ€è¦ç™»å½•çš„é¡µé¢åˆ—è¡¨
  const protectedRoutes = ['/profile', '/dashboard']
  
  if (protectedRoutes.includes(to.path) && !authStore.isLoggedIn) {
    return navigateTo('/account/login')
  }
})
```

### åˆ›å»ºæ–°çš„ API æ¨¡å—

åœ¨ `app/api/` ç›®å½•ä¸‹åˆ›å»ºæ–°çš„æ¨¡å—æ–‡ä»¶ï¼Œä¾‹å¦‚ `app/api/product.ts`ï¼š

```typescript
/**
 * å•†å“ç›¸å…³ API
 */

export interface Product {
  id: number
  name: string
  price: number
}

export const getProducts = () => {
  const { $customFetch } = useNuxtApp()
  return $customFetch<Product[]>('/api/products', {
    method: 'GET'
  })
}

export const getProductById = (id: number) => {
  const { $customFetch } = useNuxtApp()
  return $customFetch<Product>(`/api/products/${id}`, {
    method: 'GET'
  })
}
```

### åœ¨è¯·æ±‚ä¸­æ·»åŠ  Token

ä¿®æ”¹ `app/plugins/fetch-interceptor.client.ts`ï¼Œåœ¨è¯·æ±‚å¤´ä¸­è‡ªåŠ¨æ·»åŠ  tokenï¼š

```typescript
onRequest({ request, options }) {
  const authStore = useAuthStore()
  
  if (authStore.token) {
    options.headers = {
      ...options.headers,
      Authorization: `Bearer ${authStore.token}`
    }
  }
}
```

### å¤„ç† 401 æœªæˆæƒ

åœ¨æ‹¦æˆªå™¨ä¸­æ·»åŠ  401 å¤„ç†ï¼Œè‡ªåŠ¨æ¸…é™¤çŠ¶æ€å¹¶è·³è½¬åˆ°ç™»å½•é¡µï¼š

```typescript
case 401:
  const authStore = useAuthStore()
  authStore.clearAuth()
  navigateTo('/account/login')
  break;
```

## ğŸ“ ç›¸å…³æ–‡æ¡£

- [useContactFormä½¿ç”¨æŒ‡å—](./useContactFormä½¿ç”¨æŒ‡å—.md)
- [useContactFormé…ç½®åŒ–ä½¿ç”¨æŒ‡å—](./useContactFormé…ç½®åŒ–ä½¿ç”¨æŒ‡å—.md)
- [æ‚¬æµ®ç‰¹æ•ˆmixinä½¿ç”¨æŒ‡å—](./æ‚¬æµ®ç‰¹æ•ˆmixinä½¿ç”¨æŒ‡å—.md)

