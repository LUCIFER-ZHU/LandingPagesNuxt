# 认证系统使用指南

本项目已实现完整的用户认证系统，包括注册、登录和重置密码功能。

## 🚀 功能概览

### 1. 注册页面 (`/account/register`)

**功能特性：**
- 邮箱注册
- 验证码验证（90秒倒计时）
- 密码设置
- 可选用户名

**使用流程：**
1. 输入邮箱地址
2. 点击"Send Code"按钮获取验证码
3. 输入收到的验证码
4. 设置密码
5. （可选）输入用户名
6. 点击"Register"完成注册
7. 注册成功后自动跳转到登录页

**API 接口：**
- 发送验证码：`sendRegisterCode(email)` → `POST /business/customer/sendCode`
- 注册：`register(data)` → `POST /business/customer/register`

### 2. 登录页面 (`/account/login`)

**功能特性：**
- 邮箱登录
- 密码验证
- 登录状态持久化（localStorage）
- 忘记密码链接

**使用流程：**
1. 输入邮箱地址
2. 输入密码
3. 点击"Sign in"登录
4. 登录成功后跳转到首页

**API 接口：**
- 登录：`login(data)` → `POST /business/customer/login`

### 3. 重置密码页面 (`/account/reset`)

**功能特性：**
- 通过邮箱重置密码
- 验证码验证（90秒倒计时）
- 设置新密码

**使用流程：**
1. 输入邮箱地址
2. 点击"Send Code"按钮获取重置验证码
3. 输入收到的验证码
4. 设置新密码
5. 点击"Reset Password"完成重置
6. 重置成功后跳转到登录页

**API 接口：**
- 发送重置验证码：`sendResetCode(email)` → `POST /business/customer/sendResetCode`
- 重置密码：`resetPassword(data)` → `POST /business/customer/resetPassword`

## 📦 Auth Store

项目使用 Pinia 管理用户认证状态，位于 `app/stores/auth.ts`。

### State 结构

```typescript
interface AuthState {
  user: User | null           // 用户信息
  token: string | null        // 认证令牌
  isAuthenticated: boolean    // 是否已认证
}

interface User {
  id?: string | number
  email?: string
  customerName?: string
  [key: string]: any
}
```

### 可用方法

```typescript
// 设置用户信息和 token
authStore.setAuth(user, token)

// 更新用户信息
authStore.setUser(user)

// 设置 token
authStore.setToken(token)

// 清除认证信息
authStore.clearAuth()

// 登出（清除信息并跳转到登录页）
await authStore.logout()
```

### Getters

```typescript
authStore.getUser         // 获取用户信息
authStore.getToken        // 获取 token
authStore.isLoggedIn      // 是否已登录
```

### 在组件中使用

```vue
<script setup lang="ts">
import { useAuthStore } from '~/stores/auth'

const authStore = useAuthStore()

// 检查是否登录
if (authStore.isLoggedIn) {
  console.log('User:', authStore.getUser)
}

// 登出
const handleLogout = async () => {
  await authStore.logout()
}
</script>
```

## 📁 API 管理

所有认证相关的 API 接口统一管理在 `app/api/auth.ts` 文件中，提供类型安全的接口调用。

### 可用 API 函数

```typescript
// 发送注册验证码
import { sendRegisterCode } from '~/api/auth'
await sendRegisterCode('user@example.com')

// 用户注册
import { register, type RegisterRequest } from '~/api/auth'
const data: RegisterRequest = {
  email: 'user@example.com',
  code: '123456',
  password: 'password123',
  customerName: 'John Doe' // 可选
}
await register(data)

// 用户登录
import { login, type LoginRequest } from '~/api/auth'
const data: LoginRequest = {
  email: 'user@example.com',
  password: 'password123'
}
await login(data)

// 发送重置密码验证码
import { sendResetCode } from '~/api/auth'
await sendResetCode('user@example.com')

// 重置密码
import { resetPassword, type ResetPasswordRequest } from '~/api/auth'
const data: ResetPasswordRequest = {
  email: 'user@example.com',
  code: '123456',
  newPassword: 'newPassword123'
}
await resetPassword(data)
```

### 在组件中使用

```vue
<script setup lang="ts">
import { login, type LoginRequest } from '~/api/auth'

const handleLogin = async () => {
  try {
    const data: LoginRequest = {
      email: 'user@example.com',
      password: 'password123'
    }
    const response = await login(data)
    console.log('登录成功', response)
  } catch (error) {
    console.error('登录失败', error)
  }
}
</script>
```

## 🔧 技术栈

- **UI 组件库**: Nuxt UI (v4.0.1) - UCard, UInput, UButton 等
- **状态管理**: Pinia (v3.0.3) + pinia-plugin-persistedstate
- **HTTP 请求**: 自定义封装的 `$customFetch` (在 API 层统一调用)
- **通知提示**: useToast (来自 Nuxt UI)
- **路由**: Nuxt 3 内置路由 (`navigateTo`)
- **表单**: 原生 HTML label + Nuxt UI Input 组件

## 🎨 UI 特性

- 响应式设计，适配移动端和桌面端
- 深色模式支持
- 表单验证和错误提示
- 加载状态指示
- 倒计时功能（验证码发送）
- 优雅的页面跳转

## 🔐 安全特性

- 邮箱格式验证
- 必填字段验证
- 验证码过期控制（90秒）
- 密码不可见输入
- Token 持久化存储
- 错误信息脱敏处理

## 📝 注意事项

1. **验证码有效期**：验证码发送后需在 90 秒内使用
2. **Token 管理**：Token 存储在 localStorage 中，刷新页面不会丢失
3. **API 基地址**：所有请求自动使用环境变量中配置的 `apiBase`
4. **错误处理**：所有 API 错误都会通过 toast 提示给用户
5. **登录跳转**：登录成功后默认跳转到首页 (`/`)，可根据需要修改

## 🚦 页面路由

- 注册页：`/account/register`
- 登录页：`/account/login`
- 重置密码：`/account/reset`

## 🏗️ 架构设计

### API 层（app/api/）

所有后端接口调用都封装在 `app/api/` 目录下，按功能模块划分：

- `auth.ts` - 认证相关接口（注册、登录、重置密码等）
- 其他模块可以在此目录下扩展

**优势：**
- 统一管理 API 接口
- TypeScript 类型安全
- 易于维护和测试
- 复用性强

### 路由管理

项目使用 Nuxt 3 的内置路由系统，所有页面跳转使用 `navigateTo` 而非 `vue-router`：

```typescript
// ✅ 正确：使用 navigateTo
await navigateTo('/account/login')

// ❌ 错误：不使用 router.push
// router.push('/account/login')
```

**navigateTo 优势：**
- SSR 友好
- 支持服务端和客户端
- 自动处理路由预加载
- 更好的性能

## 💡 开发建议

### 添加路由守卫

可以在 `app/middleware/auth.ts` 中添加路由守卫，保护需要登录的页面：

```typescript
export default defineNuxtRouteMiddleware((to, from) => {
  const authStore = useAuthStore()
  
  // 需要登录的页面列表
  const protectedRoutes = ['/profile', '/dashboard']
  
  if (protectedRoutes.includes(to.path) && !authStore.isLoggedIn) {
    return navigateTo('/account/login')
  }
})
```

### 创建新的 API 模块

在 `app/api/` 目录下创建新的模块文件，例如 `app/api/product.ts`：

```typescript
/**
 * 商品相关 API
 */

export interface Product {
  id: number
  name: string
  price: number
}

export const getProducts = () => {
  const { $customFetch } = useNuxtApp()
  return $customFetch<Product[]>('/api/products', {
    method: 'GET'
  })
}

export const getProductById = (id: number) => {
  const { $customFetch } = useNuxtApp()
  return $customFetch<Product>(`/api/products/${id}`, {
    method: 'GET'
  })
}
```

### 在请求中添加 Token

修改 `app/plugins/fetch-interceptor.client.ts`，在请求头中自动添加 token：

```typescript
onRequest({ request, options }) {
  const authStore = useAuthStore()
  
  if (authStore.token) {
    options.headers = {
      ...options.headers,
      Authorization: `Bearer ${authStore.token}`
    }
  }
}
```

### 处理 401 未授权

在拦截器中添加 401 处理，自动清除状态并跳转到登录页：

```typescript
case 401:
  const authStore = useAuthStore()
  authStore.clearAuth()
  navigateTo('/account/login')
  break;
```

## 📞 相关文档

- [useContactForm使用指南](./useContactForm使用指南.md)
- [useContactForm配置化使用指南](./useContactForm配置化使用指南.md)
- [悬浮特效mixin使用指南](./悬浮特效mixin使用指南.md)

