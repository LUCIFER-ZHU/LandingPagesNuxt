# è®¤è¯å®‰å…¨æ€§è¯´æ˜

## ğŸ“‹ å½“å‰å®ç°

ç›®å‰é¡¹ç›®ä½¿ç”¨ `localStorage` å­˜å‚¨ç”¨æˆ·è®¤è¯ä¿¡æ¯ï¼ˆtoken å’Œç”¨æˆ·æ•°æ®ï¼‰ï¼Œå¹¶é€šè¿‡ Pinia çš„æŒä¹…åŒ–æ’ä»¶è‡ªåŠ¨ç®¡ç†ã€‚

```typescript
// app/stores/auth.ts
persist: {
  storage: localStorage  // æŒä¹…åŒ–åˆ° localStorage
}
```

## âš ï¸ localStorage çš„å®‰å…¨é£é™©

### 1. **XSS (è·¨ç«™è„šæœ¬æ”»å‡») é£é™©**

- **é—®é¢˜**ï¼šå¦‚æœç½‘ç«™å­˜åœ¨ XSS æ¼æ´ï¼Œæ¶æ„è„šæœ¬å¯ä»¥ç›´æ¥è¯»å– localStorage ä¸­çš„ token
- **ç¤ºä¾‹**ï¼š
  ```javascript
  // æ¶æ„è„šæœ¬å¯ä»¥è¿™æ ·è·å– token
  const token = localStorage.getItem('auth')
  // ç„¶åå‘é€åˆ°æ”»å‡»è€…æœåŠ¡å™¨
  ```

### 2. **æ— æ³•è®¾ç½®è¿‡æœŸæ—¶é—´**

- localStorage æ•°æ®æ°¸ä¹…ä¿å­˜ï¼Œé™¤éæ‰‹åŠ¨åˆ é™¤
- token å¯èƒ½é•¿æœŸæœ‰æ•ˆï¼Œå¢åŠ è¢«ç›—ç”¨çš„é£é™©

### 3. **æ— æ³•é˜²æ­¢ CSRF**

- localStorage çš„æ•°æ®éœ€è¦é€šè¿‡ JavaScript æ‰‹åŠ¨æ·»åŠ åˆ°è¯·æ±‚å¤´
- ä¸åƒ cookie é‚£æ ·è‡ªåŠ¨æºå¸¦

## âœ… å½“å‰é¡¹ç›®çš„å®‰å…¨æªæ–½

1. **åªåœ¨å®¢æˆ·ç«¯è®¿é—®**
   ```typescript
   if (process.client) {
     // åªåœ¨æµè§ˆå™¨ç«¯æ“ä½œ localStorage
   }
   ```

2. **æ‰‹åŠ¨æ·»åŠ è¯·æ±‚å¤´**ï¼ˆå·²ä¿®æ”¹ï¼‰
   - ä¸åœ¨æ‹¦æˆªå™¨ä¸­è‡ªåŠ¨æ·»åŠ  token
   - åœ¨éœ€è¦çš„ API ä¸­å•ç‹¬æ·»åŠ 
   - å‡å°‘ token æš´éœ²çš„èŒƒå›´

3. **é€€å‡ºç™»å½•æ¸…é™¤çŠ¶æ€**
   ```typescript
   authStore.clearAuth()  // æ¸…é™¤ localStorage
   ```

## ğŸ”’ å®‰å…¨æ”¹è¿›å»ºè®®

### æ–¹æ¡ˆ 1ï¼šä½¿ç”¨ httpOnly Cookieï¼ˆæ¨èï¼‰

**ä¼˜ç‚¹ï¼š**
- JavaScript æ— æ³•è®¿é—®ï¼Œé˜²æ­¢ XSS æ”»å‡»
- è‡ªåŠ¨æºå¸¦åˆ°è¯·æ±‚ä¸­
- å¯ä»¥è®¾ç½®è¿‡æœŸæ—¶é—´

**å®ç°ï¼š**
```typescript
// åç«¯éœ€è¦é…åˆ
// ç™»å½•æˆåŠŸåï¼Œåç«¯è®¾ç½® httpOnly cookie
res.cookie('auth_token', token, {
  httpOnly: true,     // JavaScript æ— æ³•è®¿é—®
  secure: true,       // åªåœ¨ HTTPS ä¼ è¾“
  sameSite: 'strict', // é˜²æ­¢ CSRF
  maxAge: 7 * 24 * 60 * 60 * 1000  // 7å¤©è¿‡æœŸ
})

// å‰ç«¯ä¸éœ€è¦æ‰‹åŠ¨å­˜å‚¨å’Œå‘é€ token
// Cookie ä¼šè‡ªåŠ¨æºå¸¦åˆ°æ¯ä¸ªè¯·æ±‚
```

**å‰ç«¯ä»£ç ï¼š**
```typescript
// ä¸éœ€è¦åœ¨ localStorage å­˜å‚¨ token
export interface AuthState {
  user: User | null
  isAuthenticated: boolean
  // ä¸å­˜å‚¨ token
}

// ä¸éœ€è¦æ‰‹åŠ¨æ·»åŠ  Authorization å¤´
// Cookie ä¼šè‡ªåŠ¨å‘é€
```

### æ–¹æ¡ˆ 2ï¼šToken åŠ å¯†å­˜å‚¨

å¦‚æœå¿…é¡»ä½¿ç”¨ localStorageï¼Œå¯ä»¥åŠ å¯†å­˜å‚¨ï¼š

```typescript
import CryptoJS from 'crypto-js'

const SECRET_KEY = 'your-secret-key'  // åº”è¯¥ä»ç¯å¢ƒå˜é‡è·å–

// åŠ å¯†å­˜å‚¨
const encryptToken = (token: string) => {
  return CryptoJS.AES.encrypt(token, SECRET_KEY).toString()
}

// è§£å¯†è¯»å–
const decryptToken = (encryptedToken: string) => {
  const bytes = CryptoJS.AES.decrypt(encryptedToken, SECRET_KEY)
  return bytes.toString(CryptoJS.enc.Utf8)
}

// ä½¿ç”¨
const encryptedToken = encryptToken(token)
localStorage.setItem('token', encryptedToken)
```

**æ³¨æ„**ï¼šè¿™åªæ˜¯å¢åŠ äº†æ”»å‡»éš¾åº¦ï¼Œå¹¶éå®Œå…¨å®‰å…¨ã€‚

### æ–¹æ¡ˆ 3ï¼šçŸ­æœŸ Token + Refresh Token

**æµç¨‹ï¼š**
1. ç™»å½•åè·å¾—çŸ­æœŸ access token (15åˆ†é’Ÿ) å’Œé•¿æœŸ refresh token (7å¤©)
2. access token å­˜åœ¨å†…å­˜ä¸­ï¼ˆä¸æŒä¹…åŒ–ï¼‰
3. refresh token å­˜åœ¨ httpOnly cookie æˆ–åŠ å¯†çš„ localStorage
4. token è¿‡æœŸæ—¶ï¼Œç”¨ refresh token æ¢å–æ–°çš„ access token

**å®ç°ï¼š**
```typescript
export interface AuthState {
  user: User | null
  accessToken: string | null      // å­˜å†…å­˜ï¼Œä¸æŒä¹…åŒ–
  isAuthenticated: boolean
}

// Pinia é…ç½®
persist: {
  storage: localStorage,
  paths: ['user', 'isAuthenticated']  // åªæŒä¹…åŒ–ç”¨æˆ·ä¿¡æ¯ï¼Œä¸æŒä¹…åŒ– token
}

// è‡ªåŠ¨åˆ·æ–° token
const refreshAccessToken = async () => {
  const response = await $fetch('/api/refresh', {
    method: 'POST',
    credentials: 'include'  // æºå¸¦ refresh token cookie
  })
  authStore.setAccessToken(response.accessToken)
}
```

### æ–¹æ¡ˆ 4ï¼šä½¿ç”¨ sessionStorage

å¦‚æœä¸éœ€è¦è·¨æ ‡ç­¾é¡µä¿æŒç™»å½•ï¼š

```typescript
persist: {
  storage: sessionStorage  // å…³é—­æ ‡ç­¾é¡µåè‡ªåŠ¨æ¸…é™¤
}
```

**ä¼˜ç‚¹ï¼š**
- å…³é—­æµè§ˆå™¨è‡ªåŠ¨æ¸…é™¤
- å‡å°‘ token è¢«é•¿æœŸä¿ç•™çš„é£é™©

**ç¼ºç‚¹ï¼š**
- ç”¨æˆ·ä½“éªŒè¾ƒå·®ï¼ˆéœ€è¦ç»å¸¸ç™»å½•ï¼‰

## ğŸ¯ æ¨èæ–¹æ¡ˆï¼ˆç»¼åˆï¼‰

### ç”Ÿäº§ç¯å¢ƒæ¨èé…ç½®

1. **ä½¿ç”¨ httpOnly Cookie å­˜å‚¨ token**
   ```typescript
   // nuxt.config.ts
   export default defineNuxtConfig({
     runtimeConfig: {
       public: {
         apiBase: process.env.NUXT_PUBLIC_API_BASE,
       }
     }
   })
   ```

2. **å‰ç«¯åªå­˜å‚¨å¿…è¦çš„ç”¨æˆ·ä¿¡æ¯**
   ```typescript
   // app/stores/auth.ts
   export interface AuthState {
     user: User | null           // å­˜å‚¨
     isAuthenticated: boolean    // å­˜å‚¨
     // token ä¸å­˜å‚¨ï¼Œç”± cookie ç®¡ç†
   }
   ```

3. **é…ç½® API è¯·æ±‚æºå¸¦ cookie**
   ```typescript
   const customFetch = $fetch.create({
     baseURL: apiBase,
     credentials: 'include',  // è‡ªåŠ¨æºå¸¦ cookie
   })
   ```

4. **åç«¯é…ç½® CORS**
   ```javascript
   // åç«¯é…ç½®
   app.use(cors({
     origin: 'https://your-domain.com',
     credentials: true,
     allowedHeaders: ['Content-Type', 'Authorization-Customer']
   }))
   ```

## ğŸ“ å…¶ä»–å®‰å…¨å»ºè®®

### 1. å†…å®¹å®‰å…¨ç­–ç•¥ (CSP)

åœ¨ `nuxt.config.ts` ä¸­é…ç½®ï¼š

```typescript
export default defineNuxtConfig({
  app: {
    head: {
      meta: [
        {
          'http-equiv': 'Content-Security-Policy',
          content: "default-src 'self'; script-src 'self' 'unsafe-inline' 'unsafe-eval';"
        }
      ]
    }
  }
})
```

### 2. HTTPS å¼ºåˆ¶

```typescript
// ç”Ÿäº§ç¯å¢ƒå¼ºåˆ¶ä½¿ç”¨ HTTPS
if (process.env.NODE_ENV === 'production' && !window.location.protocol.includes('https')) {
  window.location.href = window.location.href.replace('http:', 'https:')
}
```

### 3. Token è¿‡æœŸæ£€æµ‹

```typescript
// åœ¨æ‹¦æˆªå™¨ä¸­æ£€æµ‹ 401 é”™è¯¯
onResponseError({ response }) {
  if (response?.status === 401) {
    // Token è¿‡æœŸæˆ–æ— æ•ˆ
    const authStore = useAuthStore()
    authStore.clearAuth()
    navigateTo('/account/login')
  }
}
```

### 4. å®šæœŸæ›´æ–°ä¾èµ–

```bash
# æ£€æŸ¥å®‰å…¨æ¼æ´
pnpm audit

# æ›´æ–°ä¾èµ–
pnpm update
```

### 5. è¾“å…¥éªŒè¯å’Œè¾“å‡ºè½¬ä¹‰

```typescript
// é˜²æ­¢ XSS - éªŒè¯é‚®ç®±æ ¼å¼
const emailRegex = /^[^\s@]+@[^\s@]+\.[^\s@]+$/
if (!emailRegex.test(email)) {
  throw new Error('Invalid email format')
}

// ä½¿ç”¨ Vue çš„è‡ªåŠ¨è½¬ä¹‰
// {{ userInput }} ä¼šè‡ªåŠ¨è½¬ä¹‰ HTML
```

## ğŸ” å®‰å…¨å®¡è®¡æ¸…å•

- [ ] ä½¿ç”¨ httpOnly cookie å­˜å‚¨æ•æ„Ÿ token
- [ ] å¯ç”¨ HTTPS
- [ ] é…ç½® CSP (Content Security Policy)
- [ ] å®ç° token åˆ·æ–°æœºåˆ¶
- [ ] æ·»åŠ è¯·æ±‚é¢‘ç‡é™åˆ¶
- [ ] å®šæœŸå®‰å…¨å®¡è®¡
- [ ] ä½¿ç”¨ç¯å¢ƒå˜é‡ç®¡ç†å¯†é’¥
- [ ] å¯ç”¨ CORS ç™½åå•
- [ ] å®ç°ç™»å½•å¤±è´¥æ¬¡æ•°é™åˆ¶
- [ ] æ·»åŠ ç”¨æˆ·æ´»åŠ¨æ—¥å¿—

## ğŸ“š å‚è€ƒèµ„æ–™

- [OWASP Top 10](https://owasp.org/www-project-top-ten/)
- [JWT Best Practices](https://tools.ietf.org/html/rfc8725)
- [Web Storage Security](https://cheatsheetseries.owasp.org/cheatsheets/HTML5_Security_Cheat_Sheet.html#local-storage)
- [Nuxt Security Guide](https://nuxt.com/docs/guide/going-further/security)

## ğŸ’¡ ç»“è®º

**å½“å‰æ–¹æ¡ˆï¼ˆlocalStorageï¼‰ï¼š**
- âœ… å®ç°ç®€å•ï¼Œå¼€å‘å¿«é€Ÿ
- âœ… æ”¯æŒè·¨æ ‡ç­¾é¡µç™»å½•çŠ¶æ€
- âŒ å­˜åœ¨ XSS é£é™©
- âŒ Token å¯èƒ½è¢«æ¶æ„è„šæœ¬çªƒå–

**æ¨èç”Ÿäº§æ–¹æ¡ˆï¼ˆhttpOnly Cookieï¼‰ï¼š**
- âœ… æ›´å®‰å…¨ï¼Œé˜²æ­¢ XSS
- âœ… è‡ªåŠ¨ç®¡ç†ï¼Œä»£ç æ›´ç®€æ´
- âœ… å¯è®¾ç½®è¿‡æœŸæ—¶é—´
- âš ï¸ éœ€è¦åç«¯é…åˆ

**å»ºè®®ï¼š**
- å¼€å‘é˜¶æ®µå¯ä»¥ä½¿ç”¨ localStorageï¼ˆæ–¹ä¾¿è°ƒè¯•ï¼‰
- ç”Ÿäº§ç¯å¢ƒå»ºè®®æ”¹ç”¨ httpOnly Cookie + Refresh Token
- æ— è®ºå“ªç§æ–¹æ¡ˆï¼Œéƒ½è¦åšå¥½è¾“å…¥éªŒè¯å’Œ XSS é˜²æŠ¤

